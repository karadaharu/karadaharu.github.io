<html lang="en">
<head>

  
  <meta charset="utf-8">
  <title>r</title>
  <meta name="description" content="r">
  <meta name="author" content="">

  
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="http://karadaharu.org/css/fonts.css">
  
  
  <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css">
  

    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/grids-responsive-min.css">

  <link rel="stylesheet" href="http://karadaharu.org/css/custom.css">

  
  
  <link rel="stylesheet" href="http://karadaharu.org/highlight/styles/default.css">
  
  <script src="http://karadaharu.org/highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

</head>
<body>


<div class="header pure-g">
    <div class="pure-u-1-24 pure-u-md-5-24"></div>
    <div class="pure-u-11-12 pure-u-md-5-8">
        <div class="desktop pure-menu pure-menu-horizontal nav-menu">
            
            <a href="/" class="site-title pure-menu-heading">Kazumasa Kaneko</a>
            <ul class="pure-menu-list">
                
                <li class="pure-menu-item">
                    <a href="http://karadaharu.org/about/" class="pure-menu-link">About</a>
                </li>
                <li class="pure-menu-item">
                    <a href="http://karadaharu.org/works/" class="pure-menu-link">Works</a>
                </li>
                <li class="pure-menu-item">
                    <a href="http://karadaharu.org/memo/" class="pure-menu-link">Memo</a>
                </li>
                <li class="pure-menu-item">
                    <a href="http://karadaharu.org/contact/" class="pure-menu-link">Contact</a>
                </li>
            </ul>
        </div>
        <div class="mobile pure-menu nav-menu">
            <a href="/" class="pure-menu-heading" id="toggle-home">Kazumasa Kaneko</a>
            <a href="#" id="toggle-btn">&#9776;</a>
            <ul class="pure-menu-list" id="toggle-content" style="display:none;">
                
                
                <li class="pure-menu-item">
                    <a href="http://karadaharu.org/about" class="pure-menu-link">About</a>
                </li>
                <li class="pure-menu-item">
                    <a href="http://karadaharu.org/works" class="pure-menu-link">Works</a>
                </li>
                <li class="pure-menu-item">
                    <a href="http://karadaharu.org/memo" class="pure-menu-link">Memo</a>
                </li>
                <li class="pure-menu-item">
                    <a href="http://karadaharu.org/contact" class="pure-menu-link">Contact</a>
                </li>
            </ul>
        </div>
    </div>
    <div class="pure-u-1-24 pure-u-md-1-6"></div>
</div>


<div class="pure-g">
    <div class="pure-u-1-24 pure-u-md-5-24"></div>
	<div class="pure-u-11-12 pure-u-md-5-8">
        <div class="post">

            <div class="post-title">
                <p class="footnote">
		            
                    
                    

                    

                    
                </p>
                <h1>r</h1>
            </div>

            <div class="post-content">
                

<h1 id="r:cf8cb7f2f92ef3d4fe6e1f6d490de425">R</h1>

<h2 id="概要:cf8cb7f2f92ef3d4fe6e1f6d490de425">概要</h2>

<p>Rの関数は値渡しなので、引数の値を変更する、というようなことはできない。</p>

<h2 id="基本コマンド:cf8cb7f2f92ef3d4fe6e1f6d490de425">基本コマンド</h2>

<ul>
<li>setwd():ワーキングディレクトリの設定</li>
<li>getwd():カーレントディレクトリの取得</li>
<li>source():.Rファイルの読み込み(ファイル内の関数が標準入出力で使える)</li>
<li>関数の定義:

<ul>
<li>myfunc &lt;- function(引数){処理}</li>
<li>&gt;myfunc(引数)で使える</li>
</ul></li>
<li>mode(x):xの型の確認</li>
<li>str():任意(<em>arbitrary</em>)のオブジェクトの構造をみる</li>
</ul>

<p>パッケージのインストール</p>

<pre><code>&gt; options(repos=&quot;&quot;)
&gt; install.packages(&quot;name&quot;,dependencies=TRUE)
</code></pre>

<ul>
<li>install.packages(packagename, ):packageのインストール</li>
<li>library(libname):libraryの読み込み require()だと読み込めたかどうか返り値がある</li>
<li>help(function):マニュアルを見る</li>
<li>attach():サンプルデータセットを読み込む</li>
</ul>

<h2 id="パッケージのソースコードをみる:cf8cb7f2f92ef3d4fe6e1f6d490de425">パッケージのソースコードをみる</h2>

<p>まずは関数名だけを打ち込んでみるところから。</p>

<pre><code>&gt;関数名
&gt;methods(関数名)
&gt;getS3method(&quot;関数名&quot;,&quot;default&quot;)
&gt;&gt;getS3method(&quot;関数名&quot;,&quot;formula&quot;)
</code></pre>

<h2 id="型-構造:cf8cb7f2f92ef3d4fe6e1f6d490de425">型・構造</h2>

<p>基本的に、mode(var)で型は確認できる。is.hoge()でいちいち確認しなように！
オブジェクトの場合はstr(var)。
Rにおけるオブジェクトとは？
変数などすべてがオブジェクト。(Pythonとにてる?)</p>

<p>atomic  他のオブジェクトを含まないオブジェクト。配列、行列はatomicだけどリストはatomicではない。
属性：オブジェクトには属性を追加できる。ベクトル：mode, length, names以外の属性をもたないオブジェクト
クラス：あるオブジェクトがクラスに属する＝あるオブジェクトのclass属性に何らかの文字列が入っている</p>

<p>関数はatomicでもリストでもない。</p>

<pre><code>&gt; objects() # いまあるオブジェクトの一覧
&gt; rm(x) # オブジェクトxの消去
&gt; rm(list=ls(all=TRUE)) # すべてのオブジェクトの消去
</code></pre>

<h3 id="クラス:cf8cb7f2f92ef3d4fe6e1f6d490de425">クラス</h3>

<p>Rのクラスには書き方がいくつかあってよく分からない。
自分でパッケージつくるとかでなければ、とりあえず関数がどう実装されているかだけ確認できれば良さそう。</p>

<p>総称的関数とメソッド関数がある。</p>

<h3 id="型:cf8cb7f2f92ef3d4fe6e1f6d490de425">型</h3>

<ul>
<li>実数　is.numeric()</li>
<li>整数 is.integer()</li>
<li>複素数 is.complex()</li>
<li>文字列 is.character()</li>
<li>論理値 is.logical()</li>
</ul>

<h4 id="論理値:cf8cb7f2f92ef3d4fe6e1f6d490de425">論理値</h4>

<p>cond &lt;- T
cond &lt;- FALSE</p>

<h3 id="構造:cf8cb7f2f92ef3d4fe6e1f6d490de425">構造</h3>

<ul>
<li>ベクトル：同じ型をまとめたもの is.vector()</li>
<li>行列：2次元 is.matrix()</li>
<li>配列：行列を多次元に拡張したもの is.array()</li>
<li>リスト：異なる構造のデータをArrayにまとめたもの is.list()</li>
<li>データフレーム：二次元の行列で、行、列にラベルがあり、列ごとに異なるデータ型をもてる is.data.frame()</li>
</ul>

<h2 id="グラフの描画:cf8cb7f2f92ef3d4fe6e1f6d490de425">グラフの描画</h2>

<p>グラフにタイトルをつける
plot(data, main=&ldquo;タイトル&rdquo;)</p>

<p>グラフに日本語を使う
par(family=&ldquo;HiraMaruProN-W4&rdquo;)
par:グラフのパラメータを決める
x,y軸名に文字列を指定する
xlab = &ldquo;&rdquo;, ylab =&ldquo;&rdquo;</p>

<p>傾きa、切片bの直線を描く
abline(a,b),abline(c(a,b))</p>

<p>関数の曲線を描く
plot(関数名, xの下限, xの上限)</p>

<p>軸の区切りの数字がどこを指しているの要注意だわ、</p>

<h3 id="その他:cf8cb7f2f92ef3d4fe6e1f6d490de425">その他</h3>

<p>日付オブジェクトのクラス&rdquo;Date&rdquo;
日時オブジェクトのクラス&rdquo;POSIXlt&rdquo;, &ldquo;POSIXct&rdquo;</p>

<p><strong>日付を操作するときはlubridateを使おう</strong>
まだ使い方分かってないけど。</p>

<h5 id="posixlt:cf8cb7f2f92ef3d4fe6e1f6d490de425">POSIXlt</h5>

<p>名前ラベルを持つ文字列のリスト</p>

<h4 id="posixct:cf8cb7f2f92ef3d4fe6e1f6d490de425">POSIXct</h4>

<p>UNIXタイムと同じ1970年1月1日からの経過秒数</p>

<pre><code>&gt; t &lt;- Sys.time() #現在の時刻を取得
&gt; mode(t)
[1] &quot;numeric&quot;
&gt; str(t)
POSIXct[1:1], format: &quot;2014-11-13 16:15:14&quot;
&gt; t_int &lt;- as.numeric(t)
&gt; t_date &lt;- as.Date(t)
&gt; t_time &lt;- as.POSIXct(t_int,origin=&quot;1970-01-01 09:00:00&quot;) # JSTにするため　09:00:00
&gt; t_n &lt;- t + (86400 * n) # n日後
</code></pre>

<p>文字列からPOSIXctに変換</p>

<pre><code></code></pre>

<h4 id="date:cf8cb7f2f92ef3d4fe6e1f6d490de425">Date</h4>

<p>日付のみ。日時はない。</p>

<pre><code>&gt; d &lt;- Sys.Date()
&gt; d_int &lt;- as.numeric(d)
&gt; d_time &lt;- as.POSIXct(d)
&gt; d_date &lt;- as.Date(d_int, origin=&quot;1970-01-01&quot;)
&gt; d_strdate &lt;- as.Date(&quot;2001-01-01&quot;, origin=&quot;1970-01-01&quot;)
</code></pre>

<p>日付の足し算、引き算</p>

<pre><code>&gt; d1 &lt;- Sys.Date()
&gt; d2 &lt;- d1 + 1
&gt; d3 &lt;- d1 - 10
&gt; d_diff &lt;- d1 - d2
&gt; str(d_diff)
Class 'difftime'  atomic [1:1] -1
  ..- attr(*, &quot;units&quot;)= chr &quot;days&quot;
&gt; d_diff_int &lt;- as.numeric(d_diff)
</code></pre>

<p>文字列からDateクラスに変換(yyyy/mm/ddのフォーマットのみOK)</p>

<pre><code>&gt; str_d &lt;- &quot;2010/01/11&quot;
&gt; str_d_d &lt;- as.Date(str_d)
</code></pre>

<h4 id="lubridate:cf8cb7f2f92ef3d4fe6e1f6d490de425">lubridate</h4>

<p>標準化したい。
方法1:一番早い日付からの経過日数に変換
方法2:平均日からの経過日数に変換
方法3:平均日からの経過日数を分散で割る
1~3の問題点:なんか新しいデータがきたときとか、違う年度のデータを使うときとかにうまくいかなさそう
方法:4:1月1日からの日数に変換　これはいい
方法5:</p>

<p>なんかそれは何を表す値にしたいかによるきがする
集団の中ではやいか遅いかを表すなら、1,2でもいい。</p>

<pre><code>&gt;
</code></pre>

<p>千粒重 ~ 刈取り日</p>

<pre><code>
</code></pre>

<h3 id="文字列:cf8cb7f2f92ef3d4fe6e1f6d490de425">文字列</h3>

<p>文字列の連結</p>

<pre><code>&gt;paste(&quot;a&quot;, &quot;b&quot;, sep=&quot;&quot;)
</code></pre>

<p>部分一致
grep(&lsquo;a&rsquo;,&lsquo;how nice!&rsquo;)
一致するときに1,一致しないときにinteger(0)になる
ifでチェックしようとするとき、==1だとinteger(0)のとき怒られる。
つまり,1とinteger(0)をどう区別するのか問題。
integer(0)は長さ0ベクトルなので、
length(integer(0))が0になる。ふつうどんなオブジェクトもlengthは1以上。
なので、正しくは
if(length(grep(&lsquo;a&rsquo;,&lsquo;oh my god!&rsquo;))&gt;0)
でOK。</p>

<p>行列において、あるカラムにある文字が含まれている行だけ取り出したい
例:varに4が含まれているものだけ
data[grep(&lsquo;4&rsquo;,data$var),]</p>

<h3 id="配列の初期化:cf8cb7f2f92ef3d4fe6e1f6d490de425">配列の初期化</h3>

<pre><code>a &lt;- array(1:10,dim=c(2,3,4))
</code></pre>

<p>dim=c(2,3,4)で，x1が2項目，x2が3項目，x3が４項目ある配列を作れる</p>

<h3 id="ベクトル:cf8cb7f2f92ef3d4fe6e1f6d490de425">ベクトル</h3>

<ul>
<li>0がn個のベクトルを生成:numeric(n)</li>
<li>大きさを得る:lenght(x)</li>
<li>各要素にラベルをつける</li>
</ul>

<pre><code>&gt; v &lt;- c(10,3,4)
&gt; n &lt;- c(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;)
&gt; names(v) &lt;- n
</code></pre>

<p>等差数列
seq(a,b,by=c) # aからbまでcずつ増加する</p>

<h3 id="行列:cf8cb7f2f92ef3d4fe6e1f6d490de425">行列</h3>

<ul>
<li>行，列ラベルのついた任意の大きさの行列
x =matrix(numeric(4), c(2,2), dimnames=list(c(&ldquo;Ca&rdquo;,&ldquo;Cu&rdquo;),c(&ldquo;Ag&rdquo;,&ldquo;Pt&rdquo;)))</li>
<li>行列へのアクセス　i行j列目:x[i,j]</li>
</ul>

<p>奇数行のみ抽出
x[seq(1,10,by=2),]</p>

<p>逆行列の計算
solve(x)</p>

<h3 id="リスト:cf8cb7f2f92ef3d4fe6e1f6d490de425">リスト</h3>

<ul>
<li>リストの初期化
a &lt;- as.list(NA)
a[[3]] &lt;- matrix(1:4, ncol=2)
a
a[[1]]
NA
a[[2]]
NA
a[[3]]
NA</li>
</ul>

<p>複数の要素をリストにまとめる
a &lt;- &ldquo;aejiaof&rdquo;
b &lt;- 1003
c &lt;- matrix(rep(0,4),nrow=2)
mylist &lt;- list(a,b,c)</p>

<p>リストから要素を取り出す
a &lt;- mylist[[1]]
b &lt;- mylist[[2]]
c &lt;- mylist[[3]]
以下だとリストの要素ごとの箱ごとに取り出すことになってしまってダメ
a &lt;- mylist[1]</p>

<p>リストに要素を追加
append(mylist, &ldquo;aaaaa&rdquo;)</p>

<h2 id="データフレーム:cf8cb7f2f92ef3d4fe6e1f6d490de425">データフレーム</h2>

<p>初期化</p>

<p>条件を満たす一部をとりだす
subset(data, data$y &gt; 10)</p>

<h2 id="プログラミング言語との違い:cf8cb7f2f92ef3d4fe6e1f6d490de425">プログラミング言語との違い</h2>

<p>mylist[1]は配列の1番目をさす。（0はない）</p>

<h2 id="データの集計-基本関数:cf8cb7f2f92ef3d4fe6e1f6d490de425">データの集計　基本関数</h2>

<ul>
<li><p>平均:mean()</p>

<h3 id="分散:cf8cb7f2f92ef3d4fe6e1f6d490de425">分散</h3>

<p>var(),cov()は不偏分散を計算するので、
標本分散を計算するには、(n-1)/n倍しないといけない</p></li>
</ul>

<h3 id="マハラノビス距離:cf8cb7f2f92ef3d4fe6e1f6d490de425">マハラノビス距離</h3>

<p>mahalanobis()はデフォルトでinverted=FALSE
になっていて、計算する際に共分散行列をそのまま使う設定になっている。
逆行列は行列式!=0なら存在するので、
det(x)で確認できる。
行列式の意味とか定義ってなんだ、、、？</p>

<h3 id="項目の頻度をカウントする:cf8cb7f2f92ef3d4fe6e1f6d490de425">項目の頻度をカウントする</h3>

<pre><code>&gt; v &lt;- c(&quot;a&quot;,&quot;b&quot;,&quot;a&quot;,&quot;c&quot;,&quot;d&quot;,&quot;e&quot;,&quot;a&quot;,&quot;c&quot;)
&gt; r &lt;- table(v)
&gt; is.array(r)
TRUE
&gt; r[&quot;a&quot;]
</code></pre>

<h3 id="ソートする:cf8cb7f2f92ef3d4fe6e1f6d490de425">ソートする</h3>

<pre><code>&gt; sortlist &lt;- order(data$a)
&gt; sorted_data &lt;- data[sortlist,]
&gt; rownames(sorted_data) &lt;- c(1:nrow(sorted_data))
</code></pre>

<h2 id="基本関数:cf8cb7f2f92ef3d4fe6e1f6d490de425">基本関数</h2>

<p>var():不変分散を求めていうるので、標本分散にするときは、m-1/m倍する必要あり
scale:標準化（平均0, 分散1にする）
中が分からないと怖いことになる。</p>

<p>Recall():再帰的に自分自身を呼び出す。固定の名前で呼び出すと他の名前に変更した時使えない。</p>

<h2 id="回帰分析:cf8cb7f2f92ef3d4fe6e1f6d490de425">回帰分析</h2>

<h3 id="予測値を得る:cf8cb7f2f92ef3d4fe6e1f6d490de425">予測値を得る</h3>

<p>new &lt;- data.frame(weight = 68)
predict(result, newdata, interval, level=0.95)
データフレームで指定してあげないといけない。</p>

<p>predict(obj)
glm,lm,nnetなど与えられたobjのクラスによって細かい動きは変わる。
基本的にnewdataを指定してあげないと、使ったデータの予測値になる</p>

<h3 id="lm-summaryの見方:cf8cb7f2f92ef3d4fe6e1f6d490de425">lm.summaryの見方</h3>

<p>p-value:p値 偶然だとみなせる確率
residual:残差　予測値と実際の値の差</p>

<h3 id="summaryは保存できる:cf8cb7f2f92ef3d4fe6e1f6d490de425">summaryは保存できる</h3>

<p>summary &lt;- summary(result)[[1]]
summary</p>

<h3 id="結果の描画:cf8cb7f2f92ef3d4fe6e1f6d490de425">結果の描画</h3>

<p>plot(gam.model,residuals=T,se=T,pch=”。”, main=”平滑化スプラインの結”,cex.main=2)</p>

<p>residuals=Tはデータ点もプロットする
se=Tは上下の推定区間95%もひく
residual:残余、誤差</p>

<h2 id="ファイルの読み書き:cf8cb7f2f92ef3d4fe6e1f6d490de425">ファイルの読み書き</h2>

<p>読み</p>

<pre><code></code></pre>

<h3 id="書き:cf8cb7f2f92ef3d4fe6e1f6d490de425">書き</h3>

<pre><code>&gt; write.table(データフレーム名, &quot;出力するファイルのパス&quot;, append=T, quote=F, col.names=F)
</code></pre>

<p>オプション
* append:trueで追記、falseで上書き
* quote:trueで文字列が&rdquo;&ldquo;で囲われる</p>

<h2 id="欠損値の取り扱い:cf8cb7f2f92ef3d4fe6e1f6d490de425">欠損値の取り扱い</h2>

<p>欠損値:NA
非数:NaN
未定義:NULL</p>

<h3 id="nullとnaの違い:cf8cb7f2f92ef3d4fe6e1f6d490de425">NULLとNAの違い</h3>

<p>NULL→からっぽ
NA→欠損値</p>

<h3 id="naを取り除く:cf8cb7f2f92ef3d4fe6e1f6d490de425">NAを取り除く</h3>

<p>ベクトルの場合
x &lt;- c(1, 2, 3, 4, NA, NaN)
y &lt;- x[!is.na(x)]</p>

<p>行列の場合
xmat &lt;- rbind(x,x)</p>

<h3 id="naを0に置換する:cf8cb7f2f92ef3d4fe6e1f6d490de425">NAを0に置換する</h3>

<pre><code>x &lt;- c(1, 2, 3, 4, NA, NaN)

ifelse(is.na(x), 0, x)
## [1] 1 2 3 4 0 0

replace(x, which(is.na(x)), 0)
## [1] 1 2 3 4 0 0

x[is.na(x)] &lt;- 0
x
## [1] 1 2 3 4 0 0

x[which(is.na(x))] &lt;- 0
x
## [1] 1 2 3 4 0 0
</code></pre>

<h2 id="postgresとの連携:cf8cb7f2f92ef3d4fe6e1f6d490de425">postgresとの連携</h2>

<h3 id="コネクションを全部切る:cf8cb7f2f92ef3d4fe6e1f6d490de425">コネクションを全部切る</h3>

<h3 id="sql文における文字列処理:cf8cb7f2f92ef3d4fe6e1f6d490de425">SQL文における文字列処理</h3>

<pre><code>sql &lt;- 'SELECT var1, &quot;変数2&quot; FROM table1 WHERE 季節 = \'秋\' AND 変数2 IS NOT NULL'
</code></pre>

<p>SELECTのところは&rdquo;&ldquo;でくくる、whereのところは\&rsquo;\&lsquo;でくくる。なぜかは謎。</p>

<h2 id="ファイルの読み込み:cf8cb7f2f92ef3d4fe6e1f6d490de425">ファイルの読み込み</h2>

<p>カラム名があるテキスト</p>

<pre><code>x &lt;- read.table(&quot;data.txt&quot;, heade=T)
</code></pre>

<h2 id="速く計算する:cf8cb7f2f92ef3d4fe6e1f6d490de425">速く計算する</h2>

<p>for文でひとつひとつ計算させるのはゴミ。
ベクトルで計算せよ。</p>

<p>行列のうち条件を満たすもののみを返す</p>

<p>二回ガーベジコレクションで開放
gc()
gc()</p>

<h3 id="距離行列の計算:cf8cb7f2f92ef3d4fe6e1f6d490de425">距離行列の計算</h3>

<p>d &lt;- matrix(c(hogehoge),nrow=10)
d.dist &lt;- dist(d, method=&ldquo;euclidean&rdquo;)
一発で距離行列ができる</p>

<h3 id="apply関数の使いこなし:cf8cb7f2f92ef3d4fe6e1f6d490de425">apply関数の使いこなし</h3>

<p>apply(d,1,function(col){cat(col[1]);})
適用関数の第一引数が選択している列/行になる。</p>

<p>applyされる行列自体の値を変える操作はできなさそう。returnでほしい行列を新しくつくるしかない</p>

<p>assign(x[2], 2, env=.GlobalEnv)
グローバル変数への永続代入</p>

<p>引数をとる</p>

<h3 id="ソート:cf8cb7f2f92ef3d4fe6e1f6d490de425">ソート</h3>

<p>ベクトルのソート
a &lt;- c(3,23,11,4,55,93)
sort(a) # 昇順
rev(sort(a)) # 降順</p>

<p>order(a)</p>

<p>データフレームのソート</p>

<p>行列は各要素の掛け算と積は違う</p>

            </div>
        </div>
	</div>
    <div class="pure-u-1-24 pure-u-md-1-6"></div>
</div>

<div class="footer pure-g">
    <div class="pure-u-1-24 pure-u-md-5-24"></div>
    <div class="pure-u-11-12 pure-u-md-5-8">
        <div class="pure-menu pure-menu-horizontal footer-content">
            <ul>
                <li class="pure-menu-heading" id="foot-name">:</li>

                

                

                

                

                

            </ul>
            <a href="#" class="pure-menu-heading pull-right" id="gototop-btn">↑↑</a>
        </div>
	  </div>
      <div class="pure-u-1-24 pure-u-md-1-6"></div>
</div>


<script src="http://karadaharu.org/js/jquery.min.js" type="text/javascript"></script>
<script src="http://karadaharu.org/js/jquery.timeago.js" type="text/javascript"></script>
<script type="text/javascript">
  $(function(){
    $("time.timeago").timeago();
  })
  $("#toggle-btn").click(function(){
    $("#toggle-content").toggle();
    if($(this).html() === "☰") {
        $(this).html("X")
    } else {
        $(this).html("☰")
    }
  });
  $(window).resize(function(){
    if(window.innerWidth > 768) {
      $(".desktop").removeAttr("style");
    }
  });
</script>

</body>
</html>

