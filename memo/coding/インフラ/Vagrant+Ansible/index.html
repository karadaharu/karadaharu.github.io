<html lang="en">
<head>

  
  <meta charset="utf-8">
  <title>Vagrant&#43;Ansible</title>
  <meta name="description" content="Vagrant&#43;Ansible">
  <meta name="author" content="">

  
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="http://karadaharu.github.io/css/fonts.css">
  
  
  <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css">
  

    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/grids-responsive-min.css">

  <link rel="stylesheet" href="http://karadaharu.github.io/css/custom.css">

  
  
  <link rel="stylesheet" href="http://karadaharu.github.io/highlight/styles/default.css">
  
  <script src="http://karadaharu.github.io/highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

</head>
<body>


<div class="header pure-g">
    <div class="pure-u-1-24 pure-u-md-5-24"></div>
    <div class="pure-u-11-12 pure-u-md-5-8">
        <div class="desktop pure-menu pure-menu-horizontal nav-menu">
            
            <a href="/" class="site-title pure-menu-heading">Kazumasa KANEKO</a>
            <ul class="pure-menu-list">
                
                <li class="pure-menu-item">
                    <a href="http://karadaharu.github.io/about/" class="pure-menu-link">About</a>
                </li>
                <li class="pure-menu-item">
                    <a href="http://karadaharu.github.io/publications/" class="pure-menu-link">Publications</a>
                </li>
                <li class="pure-menu-item">
                    <a href="http://karadaharu.github.io/works/" class="pure-menu-link">Works</a>
                </li>
                <li class="pure-menu-item">
                    <a href="http://karadaharu.github.io/memo/" class="pure-menu-link">Memo</a>
                </li>
            </ul>
        </div>
        <div class="mobile pure-menu nav-menu">
            <a href="/" class="pure-menu-heading" id="toggle-home">Kazumasa KANEKO</a>
            <a href="#" id="toggle-btn">&#9776;</a>
            <ul class="pure-menu-list" id="toggle-content" style="display:none;">
                
                
                <li class="pure-menu-item">
                    <a href="http://karadaharu.github.io/about" class="pure-menu-link">About</a>
                </li>
                <li class="pure-menu-item">
                    <a href="http://karadaharu.github.io/publications" class="pure-menu-link">Publications</a>
                </li>
                <li class="pure-menu-item">
                    <a href="http://karadaharu.github.io/works" class="pure-menu-link">Works</a>
                </li>
                <li class="pure-menu-item">
                    <a href="http://karadaharu.github.io/memo" class="pure-menu-link">Memo</a>
                </li>
            </ul>
        </div>
    </div>
    <div class="pure-u-1-24 pure-u-md-1-6"></div>
</div>


<div class="pure-g">
    <div class="pure-u-1-24 pure-u-md-5-24"></div>
	<div class="pure-u-11-12 pure-u-md-5-8">
        <div class="post">

            <div class="post-title">
                <p class="footnote">
		            
                    
                    

                    

                    
                </p>
                <h1>Vagrant&#43;Ansible</h1>
            </div>

            <div class="post-content">
                

<h1 id="vagrant-ansibleで開発環境構築:b615a846035cd0e5bcd41b661c46ce40">Vagrant+Ansibleで開発環境構築</h1>

<h2 id="目次:b615a846035cd0e5bcd41b661c46ce40">目次</h2>

<ol>
<li>VagrantでFreeBSD, CentOSを起動</li>
<li>CentOS,FreeBSDそれぞれAnsibleを使う準備</li>
<li>CentOSからAnsibleを使って、FreeBSDの設定を変更</li>
<li>参考文献</li>
</ol>

<h2 id="1-vagrantでfreebsd-centosを起動:b615a846035cd0e5bcd41b661c46ce40">1.VagrantでFreeBSD, CentOSを起動</h2>

<p><a href="https://www.virtualbox.org/wiki/Downloads">ここ</a> から VirtualBox をダウンロードしてインストールするよ</p>

<p><a href="http://www.vagrantup.com/downloads.html">ここ</a> から Vagrant をダウンロードしてインストールするよ</p>

<p>適当なディレクトリでFreeBSDを初期化</p>

<pre><code>$ vagrant box add freebsd92 http://opscode-vm-bento.s3.amazonaws.com/vagrant/virtualbox/opscode_freebsd-9.2_chef-provisionerless.box
$ vagrant init freebsd92
</code></pre>

<p>CentOSからアクセスできるように、Vagrantfileの</p>

<pre><code>config.vm.network &quot;private_network&quot;, ip: &quot;192.168.33.10&quot;
</code></pre>

<p>のコメントアウトをはずして、ipアドレスをかぶらないように、192.168.33.11に変更</p>

<p>起動、接続</p>

<pre><code>$ vagrant up
$ vagrant ssh
</code></pre>

<p>適当なディレクトリでCentOSを初期化、起動</p>

<pre><code>$ vagrant add centos6 http://opscode-vm-bento.s3.amazonaws.com/vagrant/virtualbox/opscode_centos-6.5_chef-provisionerless.box
$ vagrant init centos6
$  vagrant up
</code></pre>

<p>起動後、Ansible で CentOS から FreeBSD へ ssh するため、Vagrant 用の秘密鍵をコピーする</p>

<pre><code>$ vagrant ssh-config &gt; ssh_config
$ scp -F ssh_config ~/.vagrant.d/insecure_private_key default:.ssh/id_rsa
</code></pre>

<p>ログインします</p>

<pre><code>$ vagrant ssh
</code></pre>

<h2 id="2-centos-freebsdそれぞれansibleを使う準備:b615a846035cd0e5bcd41b661c46ce40">2. CentOS,FreeBSDそれぞれAnsibleを使う準備</h2>

<h3 id="freebsd:b615a846035cd0e5bcd41b661c46ce40">FreeBSD</h3>

<p>基本的なツールのインストール</p>

<pre><code>$ sudo /usr/sbin/pkg
$ sudo pkg2ng
$ sudo pkg upgrade
</code></pre>

<pre><code>pkg: PACKAGESITE in pkg.conf is no longer supported.  Convert to the new repository style.  See pkg.conf(5)
pkg: Cannot parse configuration file!
</code></pre>

<p>となる場合、/usr/local/etc/pkg.conf をrmするかmvするかして、
/usr/local/etc/pkg/repos/FreeBSD.conf を下の内容で作る。
参考） <a href="https://wiki.freebsd.org/pkgng">https://wiki.freebsd.org/pkgng</a></p>

<pre><code>FreeBSD: {
  url: &quot;http://pkg.FreeBSD.org/freebsd:9:x86:64/latest&quot;,
  mirror_type: &quot;srv&quot;,
  enabled: yes
}
</code></pre>

<pre><code>freebsd92 $ sudo pkg install wget
freebsd92 $ sudo pkg install bash
freebsd92 $ sudo pkg install git
</code></pre>

<p>AnsibleがPythonの場所を/usr/bin/しか確認しないので、シンボリックリンクを作成</p>

<pre><code># ln -s /usr/local/bin/python2.7 /usr/bin/python
</code></pre>

<p>Postgresを操作するのに必要なpsycopg2をインストール
psycopg2のインストールがなぜかコケるのですが、なぜかlibicalを事前にインストールとOK</p>

<pre><code># pkg install libical-1.0
# pkg install py27-psycopg2-2.5.4
</code></pre>

<h3 id="centos:b615a846035cd0e5bcd41b661c46ce40">CentOS</h3>

<p>Pythonのバージョン2.7をインストールするのに必要なもろもろをインストール</p>

<pre><code>sudo yum install patch, git
sudo yum groupinstall &quot;Development tools&quot;
sudo yum install zlib-devel bzip2-devel openssl-devel ncurses-devel sqlite-devel readline-devel tk-deve
</code></pre>

<p>Python2.7のインストール（ソースからやらなくてもいいかも）</p>

<pre><code>$ sudo -s
# curl -O https://www.python.org/ftp/python/2.7.6/Python-2.7.6.tgz
# tar zxf Python-2.7.6.tgz
# cd Python-2.7.6
# ./configure --prefix=/opt/local
# make &amp;&amp; make altinstall
# vi ~/.bashrc
PATH=/opt/local/bin/:$PATH
# source ~/.bashrc
</code></pre>

<p>pip, Ansibleのインストール</p>

<pre><code>$ curl -kL https://raw.github.com/pypa/pip/master/contrib/get-pip.py | python2.7
$ sudo /opt/local/bin/pip2.7 install ansible
</code></pre>

<h3 id="ansibleの疎通確認:b615a846035cd0e5bcd41b661c46ce40">Ansibleの疎通確認</h3>

<pre><code>$ ansible 192.168.33.11 -m ping
ERROR: Unable to find an inventory file, specify one with -i ?
</code></pre>

<p>おっとエラーです。-i で inventory file を指定せよと言われています。Ansible はインベントリファイルに書かれたホストにしかアクセスしません。デフォルトのインベントリファイルが /etc/ansible/hosts です(ansible.cfgで定義されています)が、コマンドラインオプションの -i で指定できます。</p>

<p>ちなみに ansible.cfg は次の順で探します</p>

<p>カレントディレクトリ
環境変数の ANSIBLE_CONFIG or ~/ansible.cfg
/etc/ansible/ansible.cfg
ここではとりあえずカレントディレクトリに hosts ファイルを作成しましょう。</p>

<pre><code>$ echo 192.168.33.11 &gt; hosts
</code></pre>

<p>今度は -i でインベントリファイルを指定して ping モジュールを実行してみましょう</p>

<pre><code>$ ansible -i hosts 192.168.33.11 -m ping

paramiko: The authenticity of host '192.168.33.11' can't be established.
The ssh-rsa key fingerprint is 80c661a0ec2d1f68d5352986ad417f2c.
Are you sure you want to continue connecting (yes/no)?
yes
192.168.33.11 | success &gt;&gt; {
  &quot;changed&quot;: false,
  &quot;ping&quot;: &quot;pong&quot;
}
</code></pre>

<p>ok ですね (たしか、バージョン 1.3 から host key をチェックするようになりました)</p>

<h2 id="3-centosからansibleを使って-freebsdの設定を変更:b615a846035cd0e5bcd41b661c46ce40">3. CentOSからAnsibleを使って、FreeBSDの設定を変更</h2>

<p>hostsという名前で下記内容のファイルを記述。
これはinventor fileと呼ばれ、対象サーバーのアドレスを記述する</p>

<pre><code>[jfdb-servers]
192.168.33.10
</code></pre>

<p>以下のプレイブックをjfdb-playbook.ymlとして作成。</p>

<p><em>なぜかだめなので、gistにファイルをアップする</em></p>

<pre><code>---
- hosts: jfdb-servers
sudo: yes
tasks:
- name: be sure gmake installed
shell: yes | sudo pkg install gmake
ignore_errors: yes
- name: be sure basic modules installed
shell: yes | sudo  pkg install freetype2 jpeg png t1lib
- name: be sure basic modules installed
shell: yes | sudo pkg install libmcrypt
- name: be sure basic modules installed
shell: yes | sudo pkg install tidy-lib
- name: be sure nginx installed
shell: yes | sudo pkg install nginx
- name: by pkgng
pkgng: name=nginx state=present
- name: be sure posgres installed
pkgng: name=postgresql93-server-9.3.5 state=present
- name: make uesr for postgres
user: name=postgres
- file: path=/usr/local/pgsql/data owner=postgres state=directory
- name: init postgres
shell: /usr/local/pgsql/bin/initdb -D /usr/local/pgsql/data -E utf-8
sudo_user: postgres
- name: create db
postgresql_db: name=jfdb_dev encoding='UTF-8' owner=postgres login_user=postgres
sudo_user: postgres
- name: install php
pkgng: name=php55-5.5.19 state=present

</code></pre>

<p>シンタックスチェック</p>

<pre><code>$ ansible-playbook -i hosts jfdb-playbook.yml --syntax-check
</code></pre>

<p>ドライラン</p>

<pre><code>$ ansible-playbook -i hosts jfdb-playbook.yml --check
</code></pre>

<p>実行！</p>

<pre><code>$ ansible-playbook -i hosts jfdb-playbook.yml
</code></pre>

<p>だめです！うまくいきません！</p>

<h2 id="4-参考文献:b615a846035cd0e5bcd41b661c46ce40">4. 参考文献</h2>

<p><a href="http://yteraoka.github.io/ansible-tutorial/">Ansible チュートリアル</a>
基本的なことはここが教えてくれた。</p>

<p><a href="http://d.hatena.ne.jp/akishin999/20130815/1376520672">Ansible の Playbook を使ってみる</a>
Ansibleのデバッグについてちょっと詳しめに書いてある。</p>

<p><a href="http://docs.ansible.com/index.html">Ansible Document</a>
FreeBSD用、PostgreSQL用のモジュールの使い方はドキュメントを見るのが早い。</p>

<p><a href="https://forums.freebsd.org/threads/python-header-files-not-found.37087/">python header files not found</a>
libical入れれば大丈夫だよって教えてくれた人ありがとう。</p>

            </div>
        </div>
	</div>
    <div class="pure-u-1-24 pure-u-md-1-6"></div>
</div>

<div class="footer pure-g">
    <div class="pure-u-1-24 pure-u-md-5-24"></div>
    <div class="pure-u-11-12 pure-u-md-5-8">
        <div class="pure-menu pure-menu-horizontal footer-content">
            <ul>
                <li class="pure-menu-heading" id="foot-name">:</li>

                

                

                

                

                

            </ul>
            <a href="#" class="pure-menu-heading pull-right" id="gototop-btn">↑↑</a>
        </div>
	  </div>
      <div class="pure-u-1-24 pure-u-md-1-6"></div>
</div>


<script src="http://karadaharu.github.io/js/jquery.min.js" type="text/javascript"></script>
<script src="http://karadaharu.github.io/js/jquery.timeago.js" type="text/javascript"></script>
<script type="text/javascript">
  $(function(){
    $("time.timeago").timeago();
  })
  $("#toggle-btn").click(function(){
    $("#toggle-content").toggle();
    if($(this).html() === "☰") {
        $(this).html("X")
    } else {
        $(this).html("☰")
    }
  });
  $(window).resize(function(){
    if(window.innerWidth > 768) {
      $(".desktop").removeAttr("style");
    }
  });
</script>

</body>
</html>

