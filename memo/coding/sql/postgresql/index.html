<html lang="en">
<head>

  
  <meta charset="utf-8">
  <title>postgresql</title>
  <meta name="description" content="postgresql">
  <meta name="author" content="">

  
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="http://karadaharu.org/css/fonts.css">
  
  
  <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css">
  

    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/grids-responsive-min.css">

  <link rel="stylesheet" href="http://karadaharu.org/css/custom.css">

  
  
  <link rel="stylesheet" href="http://karadaharu.org/highlight/styles/default.css">
  
  <script src="http://karadaharu.org/highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

</head>
<body>


<div class="header pure-g">
    <div class="pure-u-1-24 pure-u-md-5-24"></div>
    <div class="pure-u-11-12 pure-u-md-5-8">
        <div class="desktop pure-menu pure-menu-horizontal nav-menu">
            
            <a href="/" class="site-title pure-menu-heading">Kazumasa Kaneko</a>
            <ul class="pure-menu-list">
                
                <li class="pure-menu-item">
                    <a href="http://karadaharu.org/about/" class="pure-menu-link">About</a>
                </li>
                <li class="pure-menu-item">
                    <a href="http://karadaharu.org/works/" class="pure-menu-link">Works</a>
                </li>
                <li class="pure-menu-item">
                    <a href="http://karadaharu.org/memo/" class="pure-menu-link">Memo</a>
                </li>
                <li class="pure-menu-item">
                    <a href="http://karadaharu.org/contact/" class="pure-menu-link">Contact</a>
                </li>
            </ul>
        </div>
        <div class="mobile pure-menu nav-menu">
            <a href="/" class="pure-menu-heading" id="toggle-home">Kazumasa Kaneko</a>
            <a href="#" id="toggle-btn">&#9776;</a>
            <ul class="pure-menu-list" id="toggle-content" style="display:none;">
                
                
                <li class="pure-menu-item">
                    <a href="http://karadaharu.org/about" class="pure-menu-link">About</a>
                </li>
                <li class="pure-menu-item">
                    <a href="http://karadaharu.org/works" class="pure-menu-link">Works</a>
                </li>
                <li class="pure-menu-item">
                    <a href="http://karadaharu.org/memo" class="pure-menu-link">Memo</a>
                </li>
                <li class="pure-menu-item">
                    <a href="http://karadaharu.org/contact" class="pure-menu-link">Contact</a>
                </li>
            </ul>
        </div>
    </div>
    <div class="pure-u-1-24 pure-u-md-1-6"></div>
</div>


<div class="pure-g">
    <div class="pure-u-1-24 pure-u-md-5-24"></div>
	<div class="pure-u-11-12 pure-u-md-5-8">
        <div class="post">

            <div class="post-title">
                <p class="footnote">
		            
                    
                    

                    

                    
                </p>
                <h1>postgresql</h1>
            </div>

            <div class="post-content">
                

<h1 id="postgresql:ca89577277ef0be4c23e5d9c6fec36ab">postgreSQL</h1>

<h2 id="ドライバ:ca89577277ef0be4c23e5d9c6fec36ab">ドライバ</h2>

<ul>
<li>あるプログラミング言語からあるデータベースに接続するためのドライバは色々ある</li>

<li><p>今回はpsycopg2</p>

<h2 id="インストール:ca89577277ef0be4c23e5d9c6fec36ab">インストール</h2></li>

<li><p><a href="http://maezono.info/2013/12/14/1390">PostgresSQL</a>のインストール</p></li>

<li><p><a href="http://tdoc.info/blog/2012/12/05/psycopg2.html">psycopg2</a>のインストール</p></li>

<li><p><strong>pipによるインストールは，どのインタプリタによるコマンドか，インストール先はどこか，に注意</strong></p></li>
</ul>

<h2 id="role:ca89577277ef0be4c23e5d9c6fec36ab">role</h2>

<p>ユーザーやグループなどのまとまりをroleとよぶ
select rolname from pg_roles;
で一覧を確認できる</p>

<p>新しいroleの作成
CREATE ROLE rolename WITH OPTIONS</p>

<p>ログインできないロールの意味</p>

<h2 id="操作:ca89577277ef0be4c23e5d9c6fec36ab">操作</h2>

<h3 id="postgresqlを直接操作:ca89577277ef0be4c23e5d9c6fec36ab">postgreSQLを直接操作</h3>

<h4 id="データベースへの接続:ca89577277ef0be4c23e5d9c6fec36ab">データベースへの接続</h4>

<p>psql -h hostname -U username -d databasename</p>

<ul>
<li>テーブル一覧の確認:\d</li>
<li>テーブルのカラム確認:\d tablename</li>
<li>テーブルの作成:create table tabelname(columnname1 type, colomname2 type);(データベースに接続していないときはdatabasename.tablename())
*</li>
<li>csvに書き出し:copy tablename to &lsquo;/file.csv&rsquo;</li>
</ul>

<h4 id="とりあえずpsqlに接続:ca89577277ef0be4c23e5d9c6fec36ab">とりあえずPSQLに接続</h4>

<p>psql -h localhost
* データベース一覧を表示:\l
ホスト名
* 新しいデータベースの作成:create database databasename;
* データベースに接続:\connect databasename;
* データベースの削除:drop database databasename;</p>

<h3 id="excelからのインポート:ca89577277ef0be4c23e5d9c6fec36ab">excelからのインポート</h3>

<p>基本の流れ
* postgresでエクセルのカラムにあわせてテーブルを作成
* エクセルで無駄な空白カラムなどは削除して、テキスト形式で保存
* 読み込む</p>

<h3 id="詳細:ca89577277ef0be4c23e5d9c6fec36ab">詳細</h3>

<ul>
<li>エクセルからcsvに出力</li>
<li>csvの拡張子をtxtに変えてテキストエディタでコピーを保存、文字コードをUTF-8にする</li>
<li>txtをcsvにまた戻す
*</li>
</ul>

<h3 id="ユーザー:ca89577277ef0be4c23e5d9c6fec36ab">ユーザー</h3>

<h3 id="psycopg2での操作:ca89577277ef0be4c23e5d9c6fec36ab">psycopg2での操作</h3>

<ul>
<li>INSERTのときのexecuteへの渡し方注意
&gt; cur.execute(&ldquo;INSERT INTO numbers VALUES (%d)&rdquo;, (42,)) # だめ
&gt; cur.execute(&ldquo;INSERT INTO numbers VALUES (%s)&rdquo;, (42,)) # OK
どんな型もすべて%sで渡す．（<strong>これはC言語ではない</strong>）型を指定したいときは，　%(int)s　などとする．</li>
</ul>

<h3 id="起動と終了:ca89577277ef0be4c23e5d9c6fec36ab">起動と終了</h3>

<p>.bashrc にデータベースファイルの場所を書いてあげたので
* 起動:pg_ctl -w start
* 終了:pg_ctl -m fast stop
* 起動しているかどうか確かめる</p>

<h2 id="仕組み:ca89577277ef0be4c23e5d9c6fec36ab">仕組み</h2>

<ul>
<li>常駐プロセス:postmaster.TCP/IPの5432番ポートをlistenしている。</li>
</ul>

<h3 id="sql操作:ca89577277ef0be4c23e5d9c6fec36ab">SQL操作</h3>

<h4 id="変更-alter-table:ca89577277ef0be4c23e5d9c6fec36ab">変更:ALTER TABLE</h4>

<p>alter database hoge rename to baka</p>

<h4 id="update:ca89577277ef0be4c23e5d9c6fec36ab">UPDATE</h4>

<p>UPDATE table1 SET column = &ldquo; WHERE</p>

<h4 id="insert:ca89577277ef0be4c23e5d9c6fec36ab">INSERT</h4>

<p>INSERT INTO table1 (id, name, sex) VALUES(1, &lsquo;たなか&rsquo;, &lsquo;male&rsquo;)</p>

<h4 id="create:ca89577277ef0be4c23e5d9c6fec36ab">CREATE</h4>

<p>CREATE TABLE table1(id serial, done bool, col1 text, col2 text, col3 text, pca1 real, pca2 real, pca3 real);</p>

<h4 id="select:ca89577277ef0be4c23e5d9c6fec36ab">SELECT</h4>

<p>一度に複数の条件のレコード数を数える</p>

<pre><code>select count(case when done = false then 1 end), count(*) from combi3;
</code></pre>

<h3 id="バックアップ:ca89577277ef0be4c23e5d9c6fec36ab">バックアップ</h3>

<p>pg_dump
pg_restore
基本</p>

<p>pg_dumpの出力は，スクリプト形式，アーカイブ形式がある．
スクリプト形式:すべてのデータを入れるSQL文として書き出し．編集すれば他のRDBMSにもインポート可能．</p>

<p>pg_dumpのオプション
&ndash;column-inserts：カラム名を含めたINSERTコマンドでダンプ
-a :データのみをダンプ(データ以外ってなんだ？)
-t tablename :特定のテーブルのみ</p>

<h4 id="sqliteへの変換:ca89577277ef0be4c23e5d9c6fec36ab">sqliteへの変換</h4>

<p>pg_dump &ldquo;JA&rdquo; -a &ndash;column-inserts -t area_yield &gt; dump.sql
で，SET文は削除，create table文を書き足せばとりあえずできる．</p>

<p>pg_dumpのヘルプ</p>

<pre><code>pg_dump --help
</code></pre>

<h2 id="部分一致検索:ca89577277ef0be4c23e5d9c6fec36ab">部分一致検索</h2>

<p>前方一致　WHERE body LIKE &lsquo;foo%&rsquo;
後方一致　WHERE body LIKE &lsquo;%foo&rsquo;
中間一致　WHERE body LIKE &lsquo;%foo%&rsquo;</p>

<p>早く検索したいとき、日本語を検索するときは、そういうふうにビルドしないといけない。</p>

            </div>
        </div>
	</div>
    <div class="pure-u-1-24 pure-u-md-1-6"></div>
</div>

<div class="footer pure-g">
    <div class="pure-u-1-24 pure-u-md-5-24"></div>
    <div class="pure-u-11-12 pure-u-md-5-8">
        <div class="pure-menu pure-menu-horizontal footer-content">
            <ul>
                <li class="pure-menu-heading" id="foot-name">:</li>

                

                

                

                

                

            </ul>
            <a href="#" class="pure-menu-heading pull-right" id="gototop-btn">↑↑</a>
        </div>
	  </div>
      <div class="pure-u-1-24 pure-u-md-1-6"></div>
</div>


<script src="http://karadaharu.org/js/jquery.min.js" type="text/javascript"></script>
<script src="http://karadaharu.org/js/jquery.timeago.js" type="text/javascript"></script>
<script type="text/javascript">
  $(function(){
    $("time.timeago").timeago();
  })
  $("#toggle-btn").click(function(){
    $("#toggle-content").toggle();
    if($(this).html() === "☰") {
        $(this).html("X")
    } else {
        $(this).html("☰")
    }
  });
  $(window).resize(function(){
    if(window.innerWidth > 768) {
      $(".desktop").removeAttr("style");
    }
  });
</script>

</body>
</html>

